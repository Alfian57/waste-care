'use client';

import React, { createContext, useContext, useState, ReactNode } from 'react';

interface Location {
  latitude: number;
  longitude: number;
}

interface ReportData {
  location: Location | null;
  photos: string[]; // Base64 encoded images
  wasteType: 'organik' | 'anorganik' | 'berbahaya' | 'campuran' | null;
  wasteVolume: 'kurang_dari_1kg' | '1_5kg' | '6_10kg' | 'lebih_dari_10kg' | null;
  locationCategory: 'sungai' | 'pinggir_jalan' | 'area_publik' | 'tanah_kosong' | 'lainnya' | null;
  notes?: string;
  // Store AI validation result after upload
  aiValidation?: {
    isWaste: boolean;
    confidence: string;
    reason?: string;
    waste_type?: string;
    waste_volume?: string;
    location_category?: string;
  };
}

interface ReportContextType {
  reportData: ReportData;
  setLocation: (location: Location) => void;
  addPhoto: (photo: string) => void;
  removePhoto: (index: number) => void;
  setWasteType: (type: ReportData['wasteType']) => void;
  setWasteVolume: (volume: ReportData['wasteVolume']) => void;
  setLocationCategory: (category: ReportData['locationCategory']) => void;
  setNotes: (notes: string) => void;
  setAiValidation: (validation: ReportData['aiValidation']) => void;
  resetReport: () => void;
}

const ReportContext = createContext<ReportContextType | undefined>(undefined);

const initialReportData: ReportData = {
  location: null,
  photos: [],
  wasteType: null,
  wasteVolume: null,
  locationCategory: null,
  notes: '',
};

export function ReportProvider({ children }: { children: ReactNode }) {
  const [reportData, setReportData] = useState<ReportData>(initialReportData);

  const setLocation = (location: Location) => {
    setReportData(prev => ({ ...prev, location }));
  };

  const addPhoto = (photo: string) => {
    setReportData(prev => ({ ...prev, photos: [...prev.photos, photo] }));
  };

  const removePhoto = (index: number) => {
    setReportData(prev => ({
      ...prev,
      photos: prev.photos.filter((_, i) => i !== index),
    }));
  };

  const setWasteType = (wasteType: ReportData['wasteType']) => {
    setReportData(prev => ({ ...prev, wasteType }));
  };

  const setWasteVolume = (wasteVolume: ReportData['wasteVolume']) => {
    setReportData(prev => ({ ...prev, wasteVolume }));
  };

  const setLocationCategory = (locationCategory: ReportData['locationCategory']) => {
    setReportData(prev => ({ ...prev, locationCategory }));
  };

  const setNotes = (notes: string) => {
    setReportData(prev => ({ ...prev, notes }));
  };

  const setAiValidation = (validation: ReportData['aiValidation']) => {
    setReportData(prev => ({ ...prev, aiValidation: validation }));
  };

  const resetReport = () => {
    setReportData(initialReportData);
  };

  return (
    <ReportContext.Provider
      value={{
        reportData,
        setLocation,
        addPhoto,
        removePhoto,
        setWasteType,
        setWasteVolume,
        setLocationCategory,
        setNotes,
        setAiValidation,
        resetReport,
      }}
    >
      {children}
    </ReportContext.Provider>
  );
}

export function useReport() {
  const context = useContext(ReportContext);
  if (context === undefined) {
    throw new Error('useReport must be used within a ReportProvider');
  }
  return context;
}
